<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.23/css/dataTables.bootstrap4.min.css">
  <title>Contracts</title>
  <style>   
    .form-group.row{
      max-width: 800px;
    }
  </style>
</head>
<body>  
  <div id="container" class="container mt-4">
  <div>
    <h2>Contracts</h2>      
    <div class="form-row my-2">
      <div class="form-group">
        <select class="form-control" id="optContractCategories" onchange="refreshTableContracts()"></select>
      </div>
      <div class="mx-auto"></div>        
      <div>
        <button type="button" class="btn btn-primary" id="addNewButton" onclick="updateContract()">Add New</button>
      </div>
    </div>

    <table class="table table-bordered" id="tableContracts">
      <thead>
        <tr></tr>
      </thead>
      <tbody>

      </tbody>
    </table>  
  </div>

</div>


<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.10.23/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.23/js/dataTables.bootstrap4.min.js"></script>

<script src="navbar.js"></script>
<script src="data.js"></script>
<script src="functions.js"></script>

<script>

  var contractCategory = ''
  const  contractMainFields = [ 'code','seller','buyer'];
  const  contractEndFields = ['status', 'sub_status', 'remarks', 'update_by', 'update_time']
  var contractRowFields = []
  var contractDetailFields = []

  function optContractCategories(){
    var opt =$('#optContractCategories')
    opt.empty()
    window_categories
      .filter(category => category.window == 'contracts')
      .map(category =>{
        opt.append(`<option value='${category.code}'>${category.text}</option>`)
      })
  }
  optContractCategories()

  function getContractData() {
    return deepCopy(contracts)
      .filter(x => x.category === contractCategory)
      .map(contract => {
          window_update_trans
          .filter(tran=> tran.contract == contract.code&&tran.window=='contracts').forEach(tran => {
            var tranStatus = getLast(tran.status); 
            if(tranStatus.status !=='canceled') {
              contract.status = tranStatus.status
              var step = approval_steps.filter(x=> x.code==tranStatus.sub_status)[0]
              contract.sub_status = step?step.text:''
              contract.update_by = tranStatus.update_by  
              contract.update_time = tranStatus.update_time  
              contract.remarks = tranStatus.remarks  
 
              tran.fields.forEach(field =>{ 
                var variable = variables.filter(x=> x.code == field.field)[0]  
                var wField = window_fields.filter(x=> x.field == field.field && x.category=== contractCategory)[0]  
                if((wField?wField.field_locs:variable.field_locs) == 'row'){
                  field.data.forEach(data =>{
                    if(data.index = -1)contract[field.field] = data.value
                  })                  
                } else{
                  contract[field.field]= field.data
                }
              });
            }           
          });
          return contract;
      }).filter(x=> x.status);
  }
  
  function contractRowButtons (code,status){
    var btns = []
    if(status!='submitted')btns.push(`<a href="#" class="mx-2" onclick="updateContract('${code}')">Edit</a>`)
    if(status=='draft')btns.push(`<a href="#" class="mx-2" onclick="submitContract('${code}')">Submit</a>`)
    if(status=='submitted')btns.push(`<a href="#" class="mx-2" onclick="approveContract('${code}')">Approve</a>`)
    if(status=='submitted')btns.push(`<a href="#" class="mx-2" onclick="returnContract('${code}')">Return</a>`)
    if(status=='returned'||status=='draft')btns.push(`<a href="#" class="mx-2" onclick="cancelContract('${code}')">Cancel</a>`)
    btns.push(`<a href="#" class="mx-2" onclick="getContractHistory('${code}')">History</a>`)
    return btns.join('')
  }
 
  function refreshTableContracts() {
    contractCategory = $('#optContractCategories').val();
    contractRowFields = ['period_start', 'period_end']; 
    contractDetailFields = []   
    window_fields
    .filter(x => x.category == contractCategory)
    .forEach(row => {
      if(row.field_locs == 'row') contractRowFields.push(row.field);
      if(row.field_locs == 'detail') contractDetailFields.push(row.field);
    });
    contractDetailFields.push('billing_template');

    var table = $('#tableContracts');
    var trHead = table.find('thead tr');
    trHead.empty();
    var contractFields = [...contractMainFields,...contractRowFields,...contractEndFields]
    contractFields.forEach(field => {
      const variable = variables.find(x => x.code === field);
      trHead.append(`<th>${variable.text}</th>`);
    });

    var tbody = table.find('tbody');
    tbody.empty();
    getContractData().forEach(row => {
        var strTr = [`<tr>`];
        var status
        contractFields.forEach(field => {
          strTr.push(`<td>${row[field] || ''}</td>`);
          if (field === 'status') status = row[field];          
        });
        strTr.push(`<td>${contractRowButtons(row['code'],status)}</td>`)
        strTr.push('</tr>');
        tbody.append(strTr.join(''));
    });
  }

  function updateContract(code=''){
    var html = [];
    var rowData = getContractData().filter(x=> x.code == code)[0];
    html.push('<div>');
    html.push('<div class="rowFields">');
    [...contractMainFields,...contractRowFields].map(field=>{
      var variable = variables.filter(x => x.code == field)[0]
      var rowField = window_fields.filter(x => x.field == field && x.category == contractCategory)[0]

      var readonly = code?['buyer','seller','code'].includes(field):false
      var required = variable.category=='system'||rowField.required
      var multiple = variable.category!='system'&&rowField.instance=='multiple'
      var value = code?rowData[field]:''

      if(variable&&variable.type=='text')html.push(htmlControlText('form',variable.code,variable.text,value,required,readonly))
      if(variable&&variable.type=='domain')html.push(htmlControlOption('form',variable.code,variable.text,value,required,readonly,getOptionDomain(field),multiple))
      if(variable&&variable.type=='number')html.push(htmlControlNumber('form',variable.code,variable.text,value,required,readonly,step))
      if(variable&&variable.type=='period')html.push(htmlControlPeriod('form',variable.code,variable.text,value,required,readonly))
    })

    html.push('</div>');

    html.push('<div class="detailFields">');
    if(contractDetailFields.length>0){      
      html.push('<table class="table table-bordered">');
      html.push('<thead><tr><th>Index</th><th>Period Start</th><th>Period End</th><th>Value</th><th></th></tr></thead>');    
      
      contractDetailFields.map(field=>{
        html.push(`<tbody val=${field}>`);
        var variable = variables.filter(x=> x.code == field)[0]  
        html.push(`<tr><td colspan="4">${variable.text}</td><td><a href="#" class="mx-2" onclick="addContractDetailRow(this,'${field}')">Add</a></td></tr>`)
        if(code&&rowData[field]){
          rowData[field].map(data=>{html.push(contractDetailRow(field, data))})
        }  
        html.push('</tbody>');
      })

      html.push('</table>');
    }
    html.push('</div>');


    

    html.push('</div>');
    html.push(`<button type="button" class="btn btn-primary" onclick="saveContract('${code}')">Save</button>`)
    modal = modalShow(code?'New':'Update' + ' Contract',html.join(''))
  }
  
  function addContractDetailRow(ctrl,code){
    $(ctrl.closest('tbody')).append(contractDetailRow(code))
  }

  function removeContractDetailRow(ctrl){
    $(ctrl.closest('tr')).empty()
  }

  function contractDetailRow(code, data){
    var variable = variables.filter(x=> x.code == code)[0] 
    var htmlIndex = htmlControlNumber('','index',variable.text,data?data.index:'',true,false,'')
    var htmlPeriodStart = htmlControlPeriod('',variable.code,variable.text,data?data.period_start:'',false,false)
    var htmlPeriodend = htmlControlPeriod('',variable.code,variable.text,data?data.period_end:'',false,false)

    var wField = window_fields.filter(x=> x.field == code && x.category == contractCategory)[0] 
    switch (variable.type) {
        case 'text':
            htmlValue = htmlControlText('table',variable.code,variable.text,data?data.value:'',true,false)
            break;
        case 'domain':
            htmlValue = htmlControlOption('table',variable.code,variable.text,data?data.value:'',true,false,getOptionDomain(code),wField?wField.instance=='multiple':false)
            break;
        case 'number':
            htmlValue = htmlControlNumber('table',variable.code,variable.text,data?data.value:'',true,false,'')
            break;
        default:
    }

    var ctrl = `<a href="#" class="mx-2" onclick="removeContractDetailRow(this)">Remove</a>`
    return `<tr class="datarow"><td>${htmlIndex}</td><td>${htmlPeriodStart}</td><td>${htmlPeriodend}</td><td>${htmlValue}</td><td>${ctrl}</td></tr>`
  }

  function saveContract(code){
    var newContract = {}  
    var newFields = []
    var errFields = []
    $.each(modal.find('.form-control'),function(i,v){
      if ($(v).prop('required')&&!$(v).val()){
        var variable = variables.filter(x=> x.code == $(v).attr('val'))[0]
        errFields.push(variable.text)
      }
    })
    if (errFields.length>0){
      alert('Required fields: \n• ' + errFields.join("\n• "));
      return
    }
    $.each(modal.find('.rowFields .form-control'),function(i,v){
      var field = $(v).attr('val');      
      var windowField = window_fields.filter(x=> x.field == field && x.category == contractCategory)[0]
      if(contractMainFields.includes(field)){
        newContract[field] = $(v).val()
      }else{        
        var prevVal = $(v).attr('prevval');
        var newVal = $(v).val()
        if(String(prevVal)!=String(newVal)){      
          newFields.push(
            {field:field,data:[{period_start:'',period_end:'',index:-1,value:newVal}]}
          )    
        }
      }      
    })

    var detailFieldList = ['index','period_start','period_end','value']
    $.each(modal.find('.detailFields tbody'),function(i,v){
      var update = false
      var field = $(v).attr('val');      
      var windowField = window_fields.filter(x=> x.field == field && x.category == contractCategory)[0]

      var newFieldData = {field:field,data:[]}

      $.each($(v).find('.datarow'),function(j,datarow){
        var data = {}
        $.each($(datarow).find('.form-control'),function(k,control){
          var prevVal = $(control).attr('prevval');
          var newVal = $(control).val()
          if(String(prevVal)!=String(newVal))update=TextTrackCue
          data[detailFieldList[k]] = newVal
        })        
        newFieldData.data.push(data)
      }) 
      if(update)newFields.push(newFieldData)
    })

    var newTrans = {window:'contracts',contract:newContract.code,
      status:[{status:'draft',sub_status:'', update_by:getUser(),update_time:getCurrentTime()}],
      fields:newFields,
    }

    if(!code){
      newContract.category = contractCategory
      contracts.push(newContract)  
    }else{
      var contract = contracts.filter(x=> x.code==code)[0] 
      if (contract)Object.assign(contract, newContract);
    }  
    
    var tran = getLast(window_update_trans.filter(x=> x.contract == code))
    var tranStatus = getLast(tran.status);
    var stats = getLast(tran.status).status
    if(stats=='draft'||stats=='returned'){
      if(stats=='draft'){
        Object.assign(tranStatus, newTrans.status[0]);
      }else{
        tran.status.push(newTrans.status[0])
      }
      newTrans.fields.map(newfield=>{
        var field = tran.fields.filter(x=> x.field == newfield.field)[0]
        if(field){
          Object.assign(field, newfield);
        }else{
          tran.fields.push(newfield)
        }
      })
    }else{
      window_update_trans.push(newTrans)
    }



    modal.modal('hide')
    refreshTableContracts()
  }

  function submitContract(code){    
    var confirmation = confirm("Are you sure you want to submit this entry?");
    if (confirmation) { 
      var trans = $(window_update_trans.filter(x=> x.contract == code)).last().get(0)
      var approvalrule = window_categories.filter(x=> x.code == contractCategory)[0].approval
      var step = approval_steps.filter(x=> x.rule==approvalrule)[0].code
      Object.assign(getLast(trans.status), {status:'submitted',sub_status:step, update_by:getUser(),update_time:getCurrentTime()});
      refreshTableContracts()
    }
  }

  function approveContract(code){    
    var confirmation = confirm("Are you sure you want to approve this entry?");
    if (confirmation) { 
      var trans = $(window_update_trans.filter(x=> x.contract == code)).last().get(0)
      var step = $(trans.status).last().get(0).sub_status
      var approvalrule = window_categories.filter(x=> x.code == contractCategory)[0].approval
      var stepindex = approval_steps.filter(x=> x.rule==approvalrule && x.code == step)[0].index
      var newStep = approval_steps.filter(x=> x.rule==approvalrule && x.index >stepindex)[0]
      trans.status.push({status:newStep?'submitted':'approved',sub_status:newStep?newStep.code:'', update_by:getUser(),update_time:getCurrentTime()})
      refreshTableContracts()
    }
  }

  function cancelContract(code){    
    var remarks = prompt("Please provide remarks for cancelling this entry:");
    if (remarks !== null && remarks.trim() !== "") {    
      var trans = $(window_update_trans.filter(x=> x.contract == code)).last().get(0)
      trans.status.push({status:'canceled',sub_status:'', update_by:getUser(),update_time:getCurrentTime(),remarks:remarks})
      refreshTableContracts()
    } else {
        alert("You must provide remarks for cancelling this entry.");
    }
  }

  function returnContract(code){    
    var remarks = prompt("Please provide remarks for returning this entry:");
    if (remarks !== null && remarks.trim() !== "") {    
      var trans = $(window_update_trans.filter(x=> x.contract == code)).last().get(0)
      trans.status.push({status:'returned',sub_status:'', update_by:getUser(),update_time:getCurrentTime(),remarks:remarks})
      refreshTableContracts()
    } else {
        alert("You must provide remarks for returning this entry.");
    }
  }
  refreshTableContracts()
  
  function getContractHistory(code){
    var html = []
    deepCopy(window_update_trans)
    .filter(tran=> tran.contract == code&&tran.window=='contracts')
    .map(tran=>{
      
      html.push('<div class="card p-3 mb-3">')
      html.push('<div style="max-width:400px">')
      html.push('<h5>Update Values</h5>')      
      html.push('<table class="table table-sm table-condensed table-bordered">')
      tran.fields.map(field=>{
        var variable = variables.filter(x=> x.code == field.field)[0] 
        html.push(`<tr><td>${variable.text}</td><td>${field.data.map(x=>{return x.value}).join(',')}</td></tr>`)
      })
      html.push('</table>')
      html.push(`</div>`)
      
      html.push('<div style="max-width:800px">')
      html.push('<h5>Approval Log</h5>')
      html.push('<table class="table table-sm table-condensed table-bordered">')
        html.push(`<tr><th>Time</th><th>User</th><th>Status</th><th>Sub Status</th><th>Remarks</th></tr>`)
      tran.status.map(stats=>{
        var substatus = approval_steps.filter(x=> x.code==stats.sub_status)[0]
        html.push(`<tr><td>${stats.update_time}</td><td>${stats.update_by}</td><td>${stats.status??''}</td><td>${substatus?substatus.text:''}</td><td>${stats.remarks??''}</td></tr>`)
      })
      html.push('</table>')
      html.push(`</div>`)
      html.push(`</div>`)
    })
    
    modal = modalShow(`Change History [${code}]`,html.join(''))
  }
 
</script>


</body>
</html>
