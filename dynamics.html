<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.23/css/dataTables.bootstrap4.min.css">
  <title>Dynamics</title>
  <style>   
    .form-group.row{
      max-width: 800px;
    }
  </style>
</head>
<body>  
  <div id="container" class="container mt-4">
  <div>
    <h2>Dynamics</h2>      
    <div class="form-row my-2">
      <div class="form-group">
        <select class="form-control" id="optDynamicCategories" onchange="refreshDynamicTable()"></select>
      </div>
      <div class="mx-auto"></div>        
      <div>
        <button type="button" class="btn btn-primary" id="addNewButton" onclick="updateDynamic()">Add New</button>
      </div>
    </div>

    <table class="table table-bordered" id="tableDynamics">
      <thead>
        <tr></tr>
      </thead>
      <tbody>

      </tbody>
    </table>  
  </div>

</div>


<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.10.23/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.23/js/dataTables.bootstrap4.min.js"></script>

<script src="navbar.js"></script>
<script src="data.js"></script>
<script src="functions.js"></script>

<script>

  var dynamicCategory = ''

  function dynamicRowButtons (arg,status){
    var btns = []
    if(status!='submitted')btns.push(`<a href="#" class="mx-2" onclick='updateDynamic(${arg})'>Edit</a>`)
    if(status=='draft')btns.push(`<a href="#" class="mx-2" onclick='submitDynamic(${arg})'>Submit</a>`)
    if(status=='submitted')btns.push(`<a href="#" class="mx-2" onclick='approveDynamic(${arg})'>Approve</a>`)
    if(status=='submitted')btns.push(`<a href="#" class="mx-2" onclick='returnDynamic(${arg})'>Return</a>`)
    if(status=='draft')btns.push(`<a href="#" class="mx-2" onclick='cancelDynamic(${arg})'>Cancel</a>`)
    btns.push(`<a href="#" class="mx-2" onclick='showDynamicHistory(${arg})'>History</a>`)
    return btns.join('')
  }

  function optDynamicCategories(){
    var opt =$('#optDynamicCategories')
    opt.empty()   
    window_categories.filter(x=> x.window == 'dynamics' ).map(x=>{
      opt.append(`<option value='${x.code}'>${x.text}</option>`)
    })
  }
  optDynamicCategories()

  var dynamicRowHeaders = []
  var dynamicDetailHeaders = []
  var dynamicSplitfields
  const endHeaders = [
    {code:'status',text:'Status'},
    {code:'sub_status',text:'Sub Status',view:'sub_status_text'},
    {code:'remarks',text:'Remarks'},
    {code:'update_by',text:'Update By'},
    {code:'update_time',text:'Update Time'},
  ]

  function getLatestDynamicData(final=false){ 
    const checkStatus = (status) => final ? status === 'approved' : status !== 'canceled';

    var query = deepCopy(window_update_trans)
    .filter(x=> checkStatus(getLast(x.status).status) && x.window == 'dynamics')
    .map(tran=>{
      var splitField = window_fields.filter(field=> field.category == tran.category && field.field_locs=='row').map(field=>field.field)
      tran.splitKey = getSplitKey(tran.splits??[],splitField)
      //pivot split field 
      tran.splits.map(split=>{
        var field = split.field
        if(dynamicSplitfields.includes(field))tran[split.field] = split.value
      }) 
      //get last status of the transaction
      tran.statuslog = tran.status
      var stat = getLast(tran.status)
      ;tran = {...tran,...stat}
      var sub_status = approval_steps.filter(x=> x.code == tran.sub_status)[0]
      tran.sub_status_text = sub_status?sub_status.text:''
      tran.remarks = tran.statuslog.filter(x=> x.remarks).map(x=> `${x.update_by}: ${x.remarks}`).join('</br>')
      return tran
    })
    return getGroupLast(query,['category','splitKey'])
  }

  function refreshDynamicTable(){    
    dynamicCategory = $('#optDynamicCategories').val();
    var table = $('#tableDynamics');
    var trHead = table.find('thead tr');
    trHead.empty();    
    dynamicRowHeaders = []
    dynamicDetailHeaders = []

    //get fields for the category
    deepCopy(window_fields).filter(x=> x.category ==dynamicCategory).map(x=>{
      var variable = deepCopy(variables).filter(y=> y.code == x.field)[0]
      variable.selector = x.field_locs=='row'?'form':'table'
      if( x.field_locs=='row'){
        variable.readonly = true
        variable.required = true
        variable.selector = 'form'
        dynamicRowHeaders.push(variable)
      }else{
        variable.selector = 'table'
        dynamicDetailHeaders.push(variable)
      }
    })
    dynamicSplitfields = dynamicRowHeaders.map(x=> x.code)
  
    //add headers to table
    var rowHeaders = [...dynamicRowHeaders,...endHeaders]    
    rowHeaders.map(header => {
      trHead.append(`<th>${header.text}</th>`);
    });
    trHead.append(`<th></th>`);

    //add data
    var tbody = table.find('tbody');
    tbody.empty();    
    getLatestDynamicData().filter(x=> x.category == dynamicCategory).map(data=>{
      var strTr = [`<tr>`];
      rowHeaders.map(header => {  
        strTr.push(`<td>${data[header.view??header.code]??''}</td>`);   
      });      
      strTr.push(`<td>${dynamicRowButtons(JSON.stringify(data),data.status)}</td>`)
      strTr.push('</tr>');
      tbody.append(strTr.join(''));
    })
  }

  function updateDynamic(item=''){
    var update = item!='';
    var html = [];
    html.push('<div>');
    html.push('<div class="rowFields">'); 
    //Row controls
    var rowHeaders = []
    deepCopy(dynamicRowHeaders).map(header=>{
      if(update)header.value = item.splits.filter(x=> x.field == header.code)[0].value
      header.required = true
      html.push(htmlControl(header,update))
      rowHeaders.push(header.code)
    })
    html.push('</div>');  
    //Details Controls
    html.push('<div class="extFields">'); 
    deepCopy(dynamicDetailHeaders.filter(x=> x.category =='dynamic')).map(header=>{
      var variable = getVariable(header.code)
      html.push(`<table class="table table-bordered detailtable" val='${variable.code}'>`); 
      var htmlHeaderTemp = []
      var htmlRowTemp = []
      xx = variable
      var detailFields =  variable.reffields.filter(x=> !dynamicRowHeaders.map(y=>{return y.code}).includes(x) ) 
      //header
      detailFields.map(reffield=>{
        var refVariable = getVariable(reffield)
        refVariable.selector = 'table'
        htmlHeaderTemp.push(`<th>${reffield}</th>`)
        htmlRowTemp.push(`<td>${htmlControl(refVariable,update)}</td>`)
      })      
      html.push(`<tr>${htmlHeaderTemp}<th>${header.text}</th><td><a href="#" class="mx-2" onclick='updateDynamicAddDetailRow(this,${JSON.stringify(variable)},${JSON.stringify(detailFields)})'>Add</a></td></tr>`)       
      //rows
      if(update){
        var dataFields = item.fields.filter(x=> x.field == header.code)[0]??{data:[]}        
        dataFields.data.map(refdata=>{
          refdata.variable = variable
          html.push(updateDynamicDetailRow(variable,detailFields,refdata))
        })        
      }
      rowHeaders.push(header.code)
      html.push('</table>');   
    }) 
    html.push('</div>');  
    html.push('</div>');
    html.push(`<button type="button" class="btn btn-primary" onclick="saveDynamic(this,${update})">Save</button>`)
    modal = modalShow(update?'New':'Update' + ' Dynamic',html.join(''))
  }

  function updateDynamicDetailRow(variable,detailFields,refdata=''){
    var html =[]
    var update = refdata!=''
    html.push(`<tr class='detailrow'>`)
    //reffields        
    detailFields.map(reffield=>{
      var refVariable = getVariable(reffield)
      refVariable.selector = 'table'
      if(update)refVariable.value = refdata.reffields.filter(x=> x.field == reffield)[0].value
      html.push(`<td>${htmlControl(refVariable,update)}</td>`)
    })
    //values          
    variable.selector = 'table'
    if(update)variable.value = refdata.value
    html.push(`<td>${htmlControl(variable,update)}</td>`)
    //button
    html.push(`<td><a href="#" class="mx-2" onclick="updateDynamicRemoveDetailRow(this)">Remove</a></td>`)       
    html.push(`</tr>`)
    return html.join('')
  }

  function updateDynamicAddDetailRow(ctrl,variable,detailFields){
    $(ctrl.closest('tbody')).append(updateDynamicDetailRow(variable,detailFields))
  }

  function updateDynamicRemoveDetailRow(ctrl){
    $(ctrl.closest('tr')).empty()
  }

  function newDynamicData(){
    return {
      window:'dynamics',
      category:dynamicCategory,
      splits:[],
      status:[{status:'draft',sub_status:'',update_by:getUser(),update_time:getCurrentTime(),remarks:''},],
      fields: []
    }
  }

  function getDynamicLatestTransItem(item){
    return getLast(getDynamicTransItem(item))
  }

  function getDynamicTransItem(item){
    return window_update_trans.filter(x=> x.category == dynamicCategory 
      && getLast(x.status).status!='canceled' 
      & getSplitKey(x.splits,dynamicSplitfields) == getSplitKey(item.splits,dynamicSplitfields))
  }

  function hasOnProccessDynamicVariable(variable,splitFields){   
    var keyVal = getSplitKey(splitFields,variable.reffields) 
    var splits = []
    getLatestDynamicData().filter(x=>x.status == 'submitted' && x.category!= dynamicCategory).map(tran=>{
      tran.fields.filter(x=> x.field == variable.code).map(field=>{
        field.data.map(data=>{
          var onProcKeyVal = getSplitKey([...(tran.splits??[]), ...data.reffields??[]],variable.reffields)
          if(onProcKeyVal==keyVal)splits.push(`Category: ${tran.category}, Variable: ${variable.code}, KeyValue: ${onProcKeyVal}`)
        })
      })
    })
    return splits      
  }

  function saveDynamic(ctrl,update){
    var errFields = []
    var newData = newDynamicData()
    var modalBody = $(ctrl).closest('.modal-body') 

    //required validation  
    $.each($(modalBody).find('.rowFields .form-control'),function(i,cell){
      var field = $(cell).attr('val');  
      var value = $(cell).val();
      var validationResult = fieldValidation(dynamicRowHeaders.filter(x=> x.code == field)[0],value)
      if (!validationResult.ok){
        errFields.push(validationResult.message)
      } else{
        newData.splits.push({field:field,value:value})
      }
    })
    $.each($(modalBody).find('.detailtable'),function(i,table){
      var field = $(table).attr('val'); 
      var fieldData = {field:field, data:[]}
      $.each($(table).find('.detailrow'),function(j,row){
        var rowData = {reffields:[]}  
        $.each($(row).find('.form-control'),function(k,cell){
          var rowfield =  $(cell).attr('val'); 
          var value = $(cell).val(); 

          var variable = getVariable(field)
          variable.required = true
          var validationResult = fieldValidation(variable,value)
          if (!validationResult.ok){
            errFields.push(validationResult.message)
          }else if(field==rowfield){
              rowData.value = value
          }else{
            rowData.reffields.push({field:rowfield,value:value})
          }         
        })
        if(rowData.value)fieldData.data.push(rowData)
      })      
      newData.fields.push(fieldData) 
    })
    if (errFields.length>0){
      alert('Error fields: \n• ' + errFields.join("\n• "));
      return
    }    
   
    //duplicate refkey validation
    errFields=[]
    newData.fields.map(dataField=>{      
      var reffieldsKeys = {}
      var variable = getVariable(dataField.field)
      dataField.data.map(data=>{
        var reffieldkey = getSplitKey(data.reffields,variable.reffields)
        if(reffieldsKeys[reffieldkey]){
          errFields.push(`${variable.text} ${reffieldkey}`)
        }else{
          reffieldsKeys[reffieldkey]=true
        }
      })
    })
    if (errFields.length>0){
      alert('Duplicate Error:\n• ' + errFields.join("\n• "));
      return
    }

    //with on proccess change variable validation
    errFields=[]
    newData.fields.map(dataField=>{      
      var variable = getVariable(dataField.field)
      dataField.data.map(data=>{
        errFields = hasOnProccessDynamicVariable(variable,[...(newData.splits??[]), ...data.reffields??[]])
      })
    })
    if (errFields.length>0){
      alert('Variable on update:\n• ' + errFields.join("\n• "));
      return
    }
    
    //previous transaction  exist warning
    var lastTrans = getDynamicLatestTransItem(newData)
    if(!update&&lastTrans){
      var confirmation = confirm(`Split fields already exist. Continuing will update the existing record.`);
      if (!confirmation) return
    }

    //previous transaction status validation
    var lastTransStatus = lastTrans?getLast(lastTrans.status).status:''
    if(lastTransStatus=='submitted'){
      alert(`A transaction with a 'submitted' status already exists; Creating another transaction is not allowed`)
      return
    }
    if(!update&&lastTransStatus=='draft'){
      var confirmation = confirm(`A transaction with a 'draft' status already exists; If you continue, this will update the transaction`);
      if (!confirmation) return
    }

    //save data
    if(lastTransStatus=='draft'){ 
      Object.assign(lastTrans, newData);
    }else{
      window_update_trans.push(newData)
    }

    modal.modal('hide')
    refreshDynamicTable()
    return
  }
    
  function submitDynamic(item){    
    var remarks = showPromptRemarks(true);
    if(remarks.ok){

      var trans = getDynamicLatestTransItem(item)
      var approvalrule = window_categories.filter(x=> x.code == dynamicCategory)[0].approval
      var step = approval_steps.filter(x=> x.rule==approvalrule)[0].code
      latestStatus = getLast(trans.status)
      var newStatus = {status:'submitted',sub_status:step, update_by:getUser(),update_time:getCurrentTime(),remarks:remarks.text}
      if(latestStatus.status=='draft'){
        Object.assign(latestStatus,newStatus)
      } else{
        trans.status.push(newStatus)
      }
      refreshDynamicTable()
    }
  }
     
  function approveDynamic(item){    
    var remarks = showPromptRemarks(false);
    if(remarks.ok){
      var trans = getDynamicLatestTransItem(item)
      var step = $(trans.status).last().get(0).sub_status
      var approvalrule = window_categories.filter(x=> x.code == dynamicCategory)[0].approval
      var stepindex = approval_steps.filter(x=> x.rule==approvalrule && x.code == step)[0].index
      var newStep = approval_steps.filter(x=> x.rule==approvalrule && x.index >stepindex)[0]
      trans.status.push({status:newStep?'submitted':'approved',sub_status:newStep?newStep.code:'', update_by:getUser(),update_time:getCurrentTime(),remarks:remarks.text})
      refreshDynamicTable()
    }
  } 
     
  function returnDynamic(item){    
    var remarks = showPromptRemarks(true);
    if(remarks.ok){
      var trans = getDynamicLatestTransItem(item)
      trans.status.push({status:'returned',sub_status:'', update_by:getUser(),update_time:getCurrentTime(),remarks:remarks.text})
      refreshDynamicTable()
    }
  } 
     
  function cancelDynamic(item){    
    var remarks = showPromptRemarks(true);
    if(remarks.ok){
      var trans = getDynamicLatestTransItem(item)
      trans.status.push({status:'canceled',sub_status:'', update_by:getUser(),update_time:getCurrentTime(),remarks:remarks.text})
      refreshDynamicTable()
    }
  } 
  
  function showDynamicHistory(item){
    var html = []
    var trans = getDynamicTransItem(item)
    var prevFields = null
    
    var prevVals = {}
    var prevFields = []
    trans.map(tran=>{     
      var newstat = getLast(tran.status).status
      html.push('<div class="card p-3 mb-3">')        

      //update values 
      html.push('<div>') 
      html.push('<h5>Update Values</h5>')      
      html.push('<table class="table table-sm table-condensed table-bordered">')
      html.push(`<tr><th></th><th>Old</th><th>New</th></tr>`)
      var newFields = []
      tran.fields.map(datafield=>{
        var field = datafield.field
        newFields.push(field)
        var htmlVal = []
        datafield.data.map(data=>{
          var refFields = data.reffields&&data.reffields.length>0?data.reffields.map(x=>x.value).join(' | ') +' | ':''  
          htmlVal.push(refFields+data.value)   
        }) 
        var newVal = htmlVal.join('</br>')
        var prevVal = prevVals[field]??''
        if(prevVal!=newVal&&newstat){
          html.push(`<tr><td>${getVariable(field).text}</td><td>${prevVal}</td><td>${newVal}</td></tr>`)
          if(newstat=='approved')prevVals[field]=newVal
        }
      }) 
      
      //for deleted values
      prevFields.filter(x=> !newFields.includes(x)).map(field=>{
        console.log(prevVals)
        html.push(`<tr><td>${getVariable(field).text}</td><td>${prevVals[field]??''}</td><td></td></tr>`)
      })
      html.push('</table>')
      html.push('</div>')
      prevFields = newFields

      //approval logs
      html.push('<div>') 
      html.push('<h5>Approval Logs</h5>')      
      html.push('<table class="table table-sm table-condensed table-bordered">')
      html.push(`<tr><th>Time</th><th>User</th><th>Status</th><th>Sub Status</th><th>Remarks</th></tr>`)
      tran.status.map(stat=>{
        var substatus = approval_steps.filter(x=> x.code==stat.sub_status)[0]
        html.push(`<tr><td>${stat.update_time}</td><td>${stat.update_by}</td><td>${stat.status??''}</td><td>${substatus?substatus.text:''}</td><td>${stat.remarks??''}</td></tr>`)
      })
      html.push('</table>')      
      html.push('</div>')

      html.push('</div>')
    })
    modal = modalShow(`Change History`,html.join(''))
  }

  refreshDynamicTable()
 
</script>


</body>
</html>
